<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–π –æ–±–ª–∞—á–Ω—ã–π –ø—Ä–æ–µ–∫—Ç</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #4f46e5;
    --primary-light: #818cf8;
    --primary-dark: #3730a3;
    --accent: #06b6d4;
    --danger: #ef4444;
    --success: #22c55e;
    --warn: #f59e0b;
    --bg: #f1f5f9;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #1e293b;
    --text-muted: #94a3b8;
    --shadow: 0 4px 24px rgba(79,70,229,0.08);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ===== TABS ===== */
  .app-tabs {
    display: flex;
    background: var(--card);
    border-bottom: 2px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }

  .tab-btn {
    flex: 1;
    padding: 16px 8px;
    border: none;
    background: transparent;
    font-family: 'Nunito', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.25s;
    border-bottom: 3px solid transparent;
    position: relative;
  }

  .tab-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
    background: linear-gradient(to bottom, #f0f0ff, transparent);
  }

  .tab-btn .badge {
    position: absolute;
    top: 8px;
    right: calc(50% - 24px);
    background: var(--danger);
    color: white;
    font-size: 10px;
    font-weight: 800;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ===== VIEWS ===== */
  .view { display: none; padding: 20px; max-width: 760px; margin: 0 auto; }
  .view.active { display: block; }

  /* ===== AUTH BAR ===== */
  .auth-bar {
    background: var(--card);
    padding: 14px 20px;
    border-radius: 14px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  .user-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: 2px solid var(--primary);
    object-fit: cover;
  }

  .user-name-tag {
    font-weight: 700;
    font-size: 15px;
    color: var(--text);
  }

  .btn {
    padding: 10px 18px;
    border: none;
    border-radius: 10px;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: var(--primary-dark); }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { opacity: 0.85; }
  .btn-sm { padding: 6px 12px; font-size: 13px; }

  /* ===== FEED FORM ===== */
  .form-card {
    background: var(--card);
    padding: 22px;
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    margin-bottom: 22px;
  }

  .form-card h3 { font-size: 16px; font-weight: 800; margin-bottom: 14px; color: var(--primary); }

  .form-input {
    width: 100%;
    padding: 11px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-family: 'Nunito', sans-serif;
    font-size: 14px;
    color: var(--text);
    background: var(--bg);
    margin-bottom: 10px;
    transition: border-color 0.2s;
  }

  .form-input:focus { outline: none; border-color: var(--primary); background: white; }

  .file-drop {
    border: 2px dashed var(--border);
    border-radius: 10px;
    padding: 18px;
    text-align: center;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 13px;
    transition: all 0.2s;
    margin-bottom: 10px;
  }

  .file-drop:hover, .file-drop.has-file { border-color: var(--primary); background: #f0f0ff; color: var(--primary); }

  .preview-image { max-width: 100%; max-height: 180px; border-radius: 10px; margin: 8px 0; }

  /* ===== POST CARDS ===== */
  .post {
    background: var(--card);
    border-radius: 16px;
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    margin-bottom: 14px;
    animation: fadeInUp 0.3s ease;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .post-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); }

  .post-name { font-weight: 700; font-size: 14px; }

  .post-time { font-size: 12px; color: var(--text-muted); margin-left: auto; }

  .status-badge {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 9px;
    border-radius: 20px;
    color: white;
    white-space: nowrap;
  }

  .status-new { background: #94a3b8; }
  .status-progress { background: var(--warn); }
  .status-done { background: var(--success); }

  .post-text { font-size: 14px; line-height: 1.5; color: var(--text); margin-bottom: 10px; }

  .post-image { width: 100%; max-height: 280px; object-fit: cover; border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: transform 0.2s; }
  .post-image:hover { transform: scale(1.01); }

  .post-actions { display: flex; gap: 8px; flex-wrap: wrap; }

  .act-btn {
    padding: 6px 14px;
    border: none;
    border-radius: 20px;
    font-family: 'Nunito', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .act-btn-like { background: #f0f9ff; color: #0284c7; }
  .act-btn-like:hover { background: #e0f2fe; }
  .act-btn-dislike { background: #fff1f2; color: var(--danger); }
  .act-btn-dislike:hover { background: #ffe4e6; }
  .act-btn-status { background: #f0f0ff; color: var(--primary); }
  .act-btn-status:hover { background: #e0e7ff; }
  .act-btn-done { background: #f0fdf4; color: var(--success); }
  .act-btn-done:hover { background: #dcfce7; }
  .act-btn-delete { background: #fff1f2; color: var(--danger); }
  .act-btn-delete:hover { background: #ffe4e6; }

  /* ===== MESSAGES VIEW ===== */
  #view-messages {
    padding: 0;
    max-width: 100%;
    height: calc(100vh - 58px);
    display: flex;
    flex-direction: column;
  }

  #view-messages.active { display: flex; }

  .dm-layout {
    display: flex;
    height: 100%;
    overflow: hidden;
  }

  /* Sidebar */
  .dm-sidebar {
    width: 300px;
    min-width: 300px;
    border-right: 1px solid var(--border);
    background: var(--card);
    display: flex;
    flex-direction: column;
  }

  .dm-sidebar-header {
    padding: 16px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--card);
  }

  .dm-sidebar-header h4 {
    font-size: 15px;
    font-weight: 800;
    color: var(--text);
  }

  .dm-search {
    padding: 10px 14px;
    border: none;
    border-bottom: 1px solid var(--border);
    width: 100%;
    font-family: 'Nunito', sans-serif;
    font-size: 14px;
    background: #f8fafc;
    color: var(--text);
  }

  .dm-search:focus { outline: none; background: white; }

  .dm-search::placeholder { color: var(--text-muted); }

  .new-chat-btn {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
  }

  .new-chat-btn:hover { background: var(--primary-dark); }

  .dm-list { overflow-y: auto; flex: 1; }

  .dm-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 18px;
    cursor: pointer;
    transition: background 0.15s;
    border-bottom: 1px solid #f1f5f9;
  }

  .dm-item:hover, .dm-item.active { background: #f0f0ff; }

  .dm-item-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    font-size: 16px;
    flex-shrink: 0;
    overflow: hidden;
  }

  .dm-item-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .dm-item-info { flex: 1; min-width: 0; }

  .dm-item-name {
    font-weight: 700;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .dm-item-preview {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
  }

  .dm-item-time { font-size: 11px; color: var(--text-muted); flex-shrink: 0; }

  .dm-item-unread {
    background: var(--primary);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 800;
    flex-shrink: 0;
  }

  /* Chat area */
  .dm-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #f8fafc;
    overflow: hidden;
  }

  .dm-chat-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    gap: 10px;
  }

  .dm-chat-empty .icon { font-size: 52px; }
  .dm-chat-empty p { font-size: 14px; font-weight: 600; }

  .dm-chat-header {
    padding: 14px 20px;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }

  .dm-chat-header-avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    font-size: 14px;
    overflow: hidden;
  }

  .dm-chat-header-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .dm-chat-header-name { font-weight: 700; font-size: 15px; }
  .dm-chat-header-email { font-size: 12px; color: var(--text-muted); }

  .dm-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    scroll-behavior: smooth;
  }

  .msg-bubble {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
    animation: bubbleIn 0.2s ease;
    word-break: break-word;
  }

  @keyframes bubbleIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  .msg-out {
    align-self: flex-end;
    background: var(--primary);
    color: white;
    border-bottom-right-radius: 4px;
  }

  .msg-in {
    align-self: flex-start;
    background: var(--card);
    color: var(--text);
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  }

  .msg-time {
    font-size: 10px;
    margin-top: 4px;
    opacity: 0.7;
    text-align: right;
  }

  .msg-in .msg-time { text-align: left; }

  .dm-input-area {
    padding: 12px 16px;
    background: var(--card);
    border-top: 1px solid var(--border);
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  .dm-text-input {
    flex: 1;
    padding: 11px 16px;
    border: 1px solid var(--border);
    border-radius: 24px;
    font-family: 'Nunito', sans-serif;
    font-size: 14px;
    resize: none;
    max-height: 100px;
    background: var(--bg);
    color: var(--text);
    transition: border-color 0.2s;
  }

  .dm-text-input:focus { outline: none; border-color: var(--primary); background: white; }

  .dm-send-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--primary);
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .dm-send-btn:hover { background: var(--primary-dark); transform: scale(1.05); }
  .dm-send-btn:disabled { background: var(--text-muted); transform: none; cursor: not-allowed; }

  /* New chat modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal-box {
    background: var(--card);
    border-radius: 20px;
    padding: 28px;
    width: 420px;
    max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  }

  .modal-box h3 { font-size: 18px; font-weight: 800; margin-bottom: 16px; color: var(--primary); }

  .user-pick-list { max-height: 320px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }

  .user-pick-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.15s;
    border: 2px solid transparent;
  }

  .user-pick-item:hover { background: #f0f0ff; }
  .user-pick-item.selected { border-color: var(--primary); background: #f0f0ff; }

  .user-pick-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    overflow: hidden;
    flex-shrink: 0;
  }

  .user-pick-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .user-pick-name { font-weight: 700; font-size: 14px; }
  .user-pick-email { font-size: 12px; color: var(--text-muted); }

  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

  /* Image modal */
  .img-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 300;
    align-items: center;
    justify-content: center;
  }

  .img-modal.open { display: flex; }

  .img-modal img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }

  .img-modal-close {
    position: absolute;
    top: 18px;
    right: 22px;
    color: white;
    font-size: 36px;
    cursor: pointer;
    line-height: 1;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

  /* Responsive */
  @media (max-width: 600px) {
    .dm-sidebar { width: 100%; min-width: unset; display: none; }
    .dm-sidebar.mobile-show { display: flex; }
    .dm-chat { display: none; }
    .dm-chat.mobile-show { display: flex; }
  }

  .section-title {
    text-align: center;
    font-size: 16px;
    font-weight: 800;
    color: #64748b;
    margin-bottom: 16px;
  }

  .not-logged {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
    font-size: 15px;
    font-weight: 600;
  }

  .not-logged .icon { font-size: 48px; display: block; margin-bottom: 12px; }

  /* ===== DEBUG PANEL ===== */
  #view-debug { display:none; padding:14px; max-width:100%; }
  #view-debug.active { display:block; }
  .debug-panel {
    background: #0f172a;
    border-radius: 12px;
    padding: 16px;
    font-family: monospace;
    font-size: 13px;
    color: #94a3b8;
    min-height: 200px;
    max-height: 60vh;
    overflow-y: auto;
  }
  .debug-panel .log-info  { color: #7dd3fc; }
  .debug-panel .log-ok    { color: #86efac; }
  .debug-panel .log-warn  { color: #fde68a; }
  .debug-panel .log-error { color: #fca5a5; font-weight: bold; }
  .debug-actions { display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap; }
  .debug-btn {
    padding: 8px 16px; border:none; border-radius:8px;
    font-family:'Nunito',sans-serif; font-weight:700; font-size:13px;
    cursor:pointer; transition:0.2s;
  }
  .debug-state {
    background:#1e293b; border-radius:10px; padding:14px;
    font-family:monospace; font-size:12px; color:#94a3b8;
    margin-bottom:12px; white-space:pre-wrap; word-break:break-all;
  }
</style>
</head>
<body>

<!-- Image modal -->
<div class="img-modal" id="imgModal">
  <span class="img-modal-close" onclick="document.getElementById('imgModal').classList.remove('open')">&times;</span>
  <img id="imgModalSrc">
</div>

<!-- New chat modal -->
<div class="modal-overlay" id="newChatModal">
  <div class="modal-box">
    <h3>üí¨ –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</h3>

    <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ email -->
    <div style="margin-bottom:14px;">
      <label style="font-size:13px;font-weight:700;color:var(--text-muted);display:block;margin-bottom:6px;">
        ‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –ø–æ email –Ω–∞–ø—Ä—è–º—É—é:
      </label>
      <div style="display:flex;gap:8px;">
        <input class="form-input" id="manualEmailInput" placeholder="example@gmail.com" type="email"
          style="margin:0;flex:1;" onkeydown="if(event.key==='Enter')startChatByEmail()">
        <button class="btn btn-primary" onclick="startChatByEmail()" style="white-space:nowrap;width:auto;padding:10px 16px;">
          –ù–∞–ø–∏—Å–∞—Ç—å
        </button>
      </div>
      <div id="emailInputError" style="color:var(--danger);font-size:12px;margin-top:4px;display:none;"></div>
    </div>

    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
      <div style="flex:1;height:1px;background:var(--border);"></div>
      <span style="font-size:12px;color:var(--text-muted);font-weight:600;">–∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞</span>
      <div style="flex:1;height:1px;background:var(--border);"></div>
    </div>

    <input class="form-input" id="userSearchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email..." oninput="filterUserList(this.value)" style="margin-bottom:10px;">
    <div class="user-pick-list" id="userPickList">
      <div style="text-align:center;color:var(--text-muted);padding:20px;font-size:14px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div class="modal-actions" style="margin-top:14px;">
      <button class="btn" onclick="closeNewChat()" style="background:var(--bg);color:var(--text);">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="startNewChat()" id="startChatBtn" disabled>–ù–∞—á–∞—Ç—å —á–∞—Ç</button>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="app-tabs">
  <button class="tab-btn active" onclick="showTab('feed')">üìã –ó–∞—è–≤–∫–∏</button>
  <button class="tab-btn" onclick="showTab('messages')" id="msgTab">
    ‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏—è
    <span class="badge" id="unreadBadge" style="display:none">0</span>
  </button>
  <button class="tab-btn" onclick="showTab('debug')" style="font-size:13px;color:#f59e0b;">üîß –õ–æ–≥–∏</button>
</div>

<!-- ===== FEED VIEW ===== -->
<div class="view active" id="view-feed">

  <!-- Auth -->
  <div class="auth-bar">
    <button class="btn btn-primary" id="loginBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <div id="userInfo" style="display:none;flex:1;align-items:center;gap:12px;display:none;">
      <img id="userPhoto" class="user-avatar" src="" alt="">
      <span class="user-name-tag" id="userName"></span>
      <button class="btn btn-danger btn-sm" id="logoutBtn" style="margin-left:auto;">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <!-- Post form -->
  <div class="form-card" id="messageForm" style="display:none;">
    <h3>‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
    <input class="form-input" type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" readonly>
    <input class="form-input" type="email" id="email" placeholder="Email" readonly>
    <input class="form-input" type="text" id="content" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...">
    <div class="file-drop" id="fileInput" onclick="document.getElementById('imageUpload').click()">
      <span id="fileInputText">üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ 5 –ú–ë)</span>
    </div>
    <input type="file" id="imageUpload" accept="image/*" style="display:none;">
    <div id="imagePreview"></div>
    <button class="btn btn-primary" id="mainBtn" style="width:100%;margin-top:6px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
  </div>

  <div class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏</div>
  <div id="feed"></div>
</div>

<!-- ===== MESSAGES VIEW ===== -->
<div class="view" id="view-debug">
  <div class="debug-actions">
    <button class="debug-btn" onclick="debugClearLogs()" style="background:#ef4444;color:white;">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
    <button class="debug-btn" onclick="debugTestSend()" style="background:#3b82f6;color:white;">üì§ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏</button>
    <button class="debug-btn" onclick="debugShowState()" style="background:#8b5cf6;color:white;">üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ</button>
    <button class="debug-btn" onclick="debugCheckFirebase()" style="background:#059669;color:white;">üî• –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Firebase</button>
  </div>
  <div id="debugState" class="debug-state">–ù–∞–∂–º–∏—Ç–µ "–°–æ—Å—Ç–æ—è–Ω–∏–µ" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
  <div class="debug-panel" id="debugLog">
    <span style="color:#475569;">// –õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</span>
  </div>
</div>

<div class="view" id="view-messages">
  <div id="dmNotLogged" class="not-logged" style="display:none;">
    <span class="icon">üîê</span>
    –í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
  </div>
  <div class="dm-layout" id="dmLayout">
    <!-- Sidebar -->
    <div class="dm-sidebar" id="dmSidebar">
      <div class="dm-sidebar-header">
        <h4>–î–∏–∞–ª–æ–≥–∏</h4>
        <button class="new-chat-btn" onclick="openNewChat()">+ –ù–æ–≤—ã–π</button>
      </div>
      <input class="dm-search" placeholder="üîç  –ü–æ–∏—Å–∫ –¥–∏–∞–ª–æ–≥–æ–≤..." id="convSearchInput" oninput="filterConvList(this.value)">
      <div class="dm-list" id="dmList">
        <div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px;">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</div>
      </div>
    </div>

    <!-- Chat panel -->
    <div class="dm-chat" id="dmChat">
      <div class="dm-chat-empty" id="dmChatEmpty">
        <div class="icon">üí¨</div>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π</p>
      </div>
      <div id="dmChatActive" style="display:none;flex-direction:column;flex:1;overflow:hidden;">
        <div class="dm-chat-header">
          <div class="dm-chat-header-avatar" id="chatHeaderAvatar">?</div>
          <div>
            <div class="dm-chat-header-name" id="chatHeaderName"></div>
            <div class="dm-chat-header-email" id="chatHeaderEmail"></div>
          </div>
        </div>
        <div class="dm-messages" id="dmMessages"></div>
        <div class="dm-input-area">
          <textarea class="dm-text-input" id="dmInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendDm();}"
            oninput="autoResize(this)"></textarea>
          <button class="dm-send-btn" id="dmSendBtn" onclick="sendDm()">‚û§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot,
  doc, updateDoc, increment, serverTimestamp, deleteDoc,
  getDocs, setDoc, where
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import {
  getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import {
  getStorage, ref, uploadBytes, getDownloadURL, deleteObject
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";

// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyBoJg-KVJ0rIHP116EwP3e-Koz2yficbXY",
  authDomain: "fir-f0bac.firebaseapp.com",
  projectId: "fir-f0bac",
  storageBucket: "fir-f0bac.firebasestorage.app",
  messagingSenderId: "1060638693890",
  appId: "1:1060638693890:web:79278db107221db79f651b"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser     = null;
let selectedImageFile = null;
let currentConvId   = null;
let currentChatEmail = null;
let allUsers        = [];
let convSnapshot    = [];
let msgUnsubscribe  = null;
let selectedNewChatUser = null;

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $  = id => document.getElementById(id);
// ‚îÄ‚îÄ‚îÄ DEBUG LOGGER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const logHistory = [];
function log(...args) {
  console.log('[APP]', ...args);
  const msg = args.map(a => {
    if (typeof a === 'object') { try { return JSON.stringify(a); } catch(e) { return String(a); } }
    return String(a);
  }).join(' ');
  logHistory.push({ msg, time: new Date().toLocaleTimeString('ru-RU') });
  appendDebugLog('info', msg);
}
function logOk(...args)    { log(...args); updateLastLogType('ok'); }
function logErr(...args) {
  const msg = args.join(' ');
  console.error('[ERR]', msg);
  logHistory.push({ msg, time: new Date().toLocaleTimeString('ru-RU'), type:'error' });
  appendDebugLog('error', '‚ùå ' + msg);
}
function appendDebugLog(type, msg) {
  const el = document.getElementById('debugLog');
  if (!el) return;
  // Remove placeholder
  if (el.querySelector('span[style]')) el.innerHTML = '';
  const line = document.createElement('div');
  const t = new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  line.className = 'log-' + type;
  line.textContent = '[' + t + '] ' + msg;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}
function updateLastLogType(type) {
  const el = document.getElementById('debugLog');
  if (!el) return;
  const lines = el.querySelectorAll('div');
  if (lines.length) lines[lines.length-1].className = 'log-' + type;
}

// Debug action buttons
window.debugClearLogs = () => {
  const el = document.getElementById('debugLog');
  if (el) el.innerHTML = '<span style="color:#475569;">// –û—á–∏—â–µ–Ω–æ...</span>';
  logHistory.length = 0;
};

window.debugShowState = () => {
  const el = document.getElementById('debugState');
  if (!el) return;
  el.textContent = JSON.stringify({
    currentUser:     currentUser ? { email: currentUser.email, name: currentUser.displayName } : null,
    currentConvId,
    currentChatEmail,
    allUsersCount:   allUsers.length,
    convCount:       convSnapshot.length,
    allUsers:        allUsers.map(u => u.email),
    convSnapshot:    convSnapshot.map(c => ({ id: c.id, p: c.participantsEmails, last: c.lastMessage }))
  }, null, 2);
};

window.debugTestSend = async () => {
  appendDebugLog('warn', '=== –¢–ï–°–¢ –û–¢–ü–†–ê–í–ö–ò ===');
  appendDebugLog('info', 'currentUser: ' + (currentUser?.email || '–ù–ï–¢'));
  appendDebugLog('info', 'currentConvId: ' + (currentConvId || '–ù–ï–¢'));
  appendDebugLog('info', 'currentChatEmail: ' + (currentChatEmail || '–ù–ï–¢'));
  if (!currentUser) { appendDebugLog('error', '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!'); return; }
  if (!currentConvId) { appendDebugLog('error', '–î–∏–∞–ª–æ–≥ –Ω–µ –æ—Ç–∫—Ä—ã—Ç ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π'); return; }
  try {
    appendDebugLog('info', '–ü—Ä–æ–±—É–µ–º –∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –≤ messages...');
    const ref2 = await addDoc(collection(db,'messages'), {
      conversationId: currentConvId,
      fromEmail:      currentUser.email,
      toEmail:        currentChatEmail || 'test@test.com',
      text:           'üîß –¢–ï–°–¢ ' + new Date().toLocaleTimeString(),
      createdAt:      serverTimestamp()
    });
    appendDebugLog('ok', '‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∞–Ω–æ! ID: ' + ref2.id);
  } catch(e) {
    appendDebugLog('error', '–û–®–ò–ë–ö–ê: ' + e.code + ' ‚Äî ' + e.message);
  }
};

window.debugCheckFirebase = async () => {
  appendDebugLog('warn', '=== –ü–†–û–í–ï–†–ö–ê FIREBASE ===');
  // Test read users
  try {
    const snap = await getDocs(collection(db,'users'));
    appendDebugLog('ok', '‚úÖ users: —á–∏—Ç–∞–µ–º OK, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ' + snap.size);
  } catch(e) { appendDebugLog('error', 'users READ: ' + e.code + ' ' + e.message); }
  // Test read conversations
  try {
    const snap = await getDocs(collection(db,'conversations'));
    appendDebugLog('ok', '‚úÖ conversations: —á–∏—Ç–∞–µ–º OK, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ' + snap.size);
  } catch(e) { appendDebugLog('error', 'conversations READ: ' + e.code + ' ' + e.message); }
  // Test read messages
  try {
    const snap = await getDocs(collection(db,'messages'));
    appendDebugLog('ok', '‚úÖ messages: —á–∏—Ç–∞–µ–º OK, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ' + snap.size);
  } catch(e) { appendDebugLog('error', 'messages READ: ' + e.code + ' ' + e.message); }
  // Test write
  if (currentUser) {
    try {
      const ref2 = await addDoc(collection(db,'_debug_test'), {
        uid: currentUser.uid, ts: serverTimestamp()
      });
      appendDebugLog('ok', '‚úÖ –ó–∞–ø–∏—Å—å –≤ Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç! ID: ' + ref2.id);
    } catch(e) { appendDebugLog('error', 'WRITE TEST: ' + e.code + ' ' + e.message); }
  } else {
    appendDebugLog('warn', '‚ö†Ô∏è –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî —Ç–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–ø—É—â–µ–Ω');
  }
};

function getInitials(name) {
  if (!name) return '?';
  return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
}
function getOtherEmail(conv) {
  return (conv.participantsEmails || []).find(e => e !== currentUser?.email) || '';
}
function getUserByEmail(email) {
  return allUsers.find(u => u.email === email);
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showTab = (tab) => {
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active',
      (i===0 && tab==='feed') || (i===1 && tab==='messages') || (i===2 && tab==='debug'));
  });
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  $('view-' + tab).classList.add('active');
  if (tab==='debug') { setTimeout(window.debugShowState, 100); }
};

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('loginBtn').onclick  = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
$('logoutBtn').onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if (user) {
    log('–í–æ—à—ë–ª:', user.email);
    $('loginBtn').style.display = 'none';
    $('userInfo').style.display = 'flex';
    $('userName').textContent   = user.displayName;
    $('userPhoto').src          = user.photoURL || '';
    $('name').value             = user.displayName;
    $('email').value            = user.email;
    $('messageForm').style.display = 'block';
    $('dmNotLogged').style.display = 'none';
    $('dmLayout').style.display    = 'flex';

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore
    try {
      await setDoc(doc(db, 'users', user.uid), {
        email: user.email,
        name:  user.displayName,
        photo: user.photoURL || '',
        updatedAt: serverTimestamp()
      }, { merge: true });
      log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ users');
    } catch(e) { log('–û—à–∏–±–∫–∞ setDoc users:', e.message); }

    loadAllUsers();
    listenConversations();
  } else {
    $('loginBtn').style.display     = 'block';
    $('userInfo').style.display     = 'none';
    $('messageForm').style.display  = 'none';
    $('dmNotLogged').style.display  = 'block';
    $('dmLayout').style.display     = 'none';
  }
});

// ‚îÄ‚îÄ‚îÄ LOAD USERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAllUsers() {
  try {
    const snap = await getDocs(collection(db, 'users'));
    allUsers = [];
    snap.forEach(d => {
      const data = d.data();
      if (data.email !== currentUser?.email) {
        allUsers.push({ uid: d.id, ...data });
      }
    });
    log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', allUsers.length);
  } catch(e) { log('–û—à–∏–±–∫–∞ loadAllUsers:', e.message); }
}

// ‚îÄ‚îÄ‚îÄ IMAGE UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('imageUpload').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5*1024*1024) { alert('–§–∞–π–ª > 5 –ú–ë'); e.target.value=''; return; }
  if (!file.type.startsWith('image/')) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'); e.target.value=''; return; }
  selectedImageFile = file;
  $('fileInput').classList.add('has-file');
  $('fileInputText').textContent = `üì∏ ${file.name}`;
  const reader = new FileReader();
  reader.onload = ev => {
    $('imagePreview').innerHTML = `
      <img src="${ev.target.result}" class="preview-image">
      <button class="btn btn-danger btn-sm" style="margin-top:6px;" onclick="removeImg()">–£–¥–∞–ª–∏—Ç—å</button>`;
  };
  reader.readAsDataURL(file);
});

window.removeImg = () => {
  selectedImageFile = null;
  $('imageUpload').value = '';
  $('fileInput').classList.remove('has-file');
  $('fileInputText').textContent = 'üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ 5 –ú–ë)';
  $('imagePreview').innerHTML = '';
};

async function uploadImage(file, userId) {
  const name = `${Date.now()}_${file.name}`;
  const r = ref(storage, `images/${userId}/${name}`);
  const snap = await uploadBytes(r, file);
  const url = await getDownloadURL(snap.ref);
  return { url, path: `images/${userId}/${name}` };
}

// ‚îÄ‚îÄ‚îÄ POST SUBMIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('mainBtn').onclick = async (e) => {
  e.preventDefault();
  const content = $('content').value.trim();
  if (!content) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!');
  const btn = $('mainBtn');
  btn.disabled = true; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
  try {
    let imageData = null;
    if (selectedImageFile) imageData = await uploadImage(selectedImageFile, currentUser.uid);
    await addDoc(collection(db, 'requests'), {
      name: currentUser.displayName,
      email: currentUser.email,
      photo: currentUser.photoURL,
      text: content,
      likes: 0, dislikes: 0,
      status: 'new',
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      imageUrl:  imageData?.url  || null,
      imagePath: imageData?.path || null,
      userId: currentUser.uid
    });
    $('content').value = '';
    removeImg();
    alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
  } catch(err) { console.error(err); alert('–û—à–∏–±–∫–∞: ' + err.message); }
  finally { btn.disabled = false; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ'; }
};

// ‚îÄ‚îÄ‚îÄ FEED LISTENER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const feedQ = query(collection(db, 'requests'), orderBy('createdAt', 'desc'));
onSnapshot(feedQ, (snapshot) => {
  const feed = $('feed');
  feed.innerHTML = '';
  if (snapshot.empty) {
    feed.innerHTML = '<p style="text-align:center;color:#94a3b8;padding:30px;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</p>';
    return;
  }
  snapshot.forEach((ds) => {
    const data = ds.data(), id = ds.id;
    const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleString('ru-RU') : '‚Ä¶';
    const sc = {new:'new',in_progress:'progress',done:'done'}[data.status||'new']||'new';
    const sl = {new:'–ù–æ–≤–æ–µ',in_progress:'–í —Ä–∞–±–æ—Ç–µ',done:'–ó–∞–≤–µ—Ä—à–µ–Ω–æ'}[data.status||'new']||'new';
    const img = data.imageUrl
      ? `<img src="${data.imageUrl}" class="post-image" onclick="window._openImg('${data.imageUrl}')">`
      : '';
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `
      <div class="post-header">
        <img src="${data.photo||'https://via.placeholder.com/32'}" class="post-avatar"
             onerror="this.src='https://via.placeholder.com/32'">
        <span class="post-name">${data.name||'–ê–Ω–æ–Ω–∏–º'}</span>
        <span class="post-time">${time}</span>
        <span class="status-badge status-${sc}">${sl}</span>
      </div>
      <p class="post-text">${data.text||data.email||''}</p>
      ${img}
      <div class="post-actions">
        <button class="act-btn act-btn-like"    onclick="window._like('${id}')">üëç ${data.likes||0}</button>
        <button class="act-btn act-btn-dislike" onclick="window._dislike('${id}')">üëé ${data.dislikes||0}</button>
        <button class="act-btn act-btn-status"  onclick="window._status('${id}','in_progress')">–í —Ä–∞–±–æ—Ç—É</button>
        <button class="act-btn act-btn-done"    onclick="window._status('${id}','done')">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</button>
        <button class="act-btn act-btn-delete"  onclick="window._delete('${id}','${data.imagePath||''}')">üóë</button>
      </div>`;
    feed.appendChild(div);
  });
}, err => {
  $('feed').innerHTML = `<p style="color:red;text-align:center;">–û—à–∏–±–∫–∞: ${err.message}</p>`;
});

window._like    = id => updateDoc(doc(db,'requests',id),{likes:increment(1),updatedAt:serverTimestamp()}).catch(console.error);
window._dislike = id => {
  if (localStorage.getItem('dl_'+id)==='1') return alert('–£–∂–µ –¥–∏–∑–ª–∞–π–∫');
  updateDoc(doc(db,'requests',id),{dislikes:increment(1),updatedAt:serverTimestamp()})
    .then(()=>localStorage.setItem('dl_'+id,'1')).catch(console.error);
};
window._status  = (id,s) => updateDoc(doc(db,'requests',id),{status:s,updatedAt:serverTimestamp()}).catch(console.error);
window._delete  = async (id, imgPath) => {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
  if (imgPath) { try { await deleteObject(ref(storage,imgPath)); } catch(e){} }
  await deleteDoc(doc(db,'requests',id)).catch(console.error);
};
window._openImg = url => {
  $('imgModalSrc').src = url;
  $('imgModal').classList.add('open');
};

// ‚îÄ‚îÄ‚îÄ CONVERSATIONS LISTENER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function listenConversations() {
  if (!currentUser) return;
  // –ß–∏—Ç–∞–µ–º –í–°–ï conversations ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
  // (Firebase –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç array-contains –ø–æ email –±–µ–∑ —Å–ø–µ—Ü. –∏–Ω–¥–µ–∫—Å–∞)
  const cq = query(collection(db, 'conversations'), orderBy('updatedAt','desc'));
  onSnapshot(cq, snap => {
    convSnapshot = [];
    snap.forEach(d => {
      const data = d.data();
      if ((data.participantsEmails||[]).includes(currentUser.email)) {
        convSnapshot.push({ id: d.id, ...data });
      }
    });
    log('–î–∏–∞–ª–æ–≥–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', convSnapshot.length);
    renderConvList();
  }, err => {
    log('–û—à–∏–±–∫–∞ conversations onSnapshot:', err.code, err.message);
  });
}

// ‚îÄ‚îÄ‚îÄ RENDER CONV LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderConvList(filter='') {
  const list = $('dmList');
  list.innerHTML = '';
  const filtered = convSnapshot.filter(c =>
    getOtherEmail(c).toLowerCase().includes(filter.toLowerCase())
  );
  if (!filtered.length) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px;">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</div>';
    return;
  }
  filtered.forEach(conv => {
    const other = getOtherEmail(conv);
    const user  = getUserByEmail(other);
    const name  = user?.name || other;
    const photo = user?.photo || '';
    const preview = conv.lastMessage
      ? conv.lastMessage.slice(0,40) + (conv.lastMessage.length>40?'‚Ä¶':'')
      : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
    const time = conv.updatedAt
      ? new Date(conv.updatedAt.toDate()).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})
      : '';
    const item = document.createElement('div');
    item.className = 'dm-item' + (conv.id===currentConvId ? ' active' : '');
    item.innerHTML = `
      <div class="dm-item-avatar">
        ${photo ? `<img src="${photo}" onerror="this.style.display='none'">${getInitials(name)}` : getInitials(name)}
      </div>
      <div class="dm-item-info">
        <div class="dm-item-name">${name}</div>
        <div class="dm-item-preview">${preview}</div>
      </div>
      <div class="dm-item-time">${time}</div>`;
    item.onclick = () => openConversation(conv.id, other);
    list.appendChild(item);
  });
}

window.filterConvList = val => renderConvList(val);

// ‚îÄ‚îÄ‚îÄ OPEN CONVERSATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openConversation(convId, otherEmail) {
  log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥:', convId, '—Å', otherEmail);
  currentConvId    = convId;
  currentChatEmail = otherEmail;

  const user  = getUserByEmail(otherEmail);
  const name  = user?.name || otherEmail;
  const photo = user?.photo || '';

  const av = $('chatHeaderAvatar');
  av.innerHTML = photo
    ? `<img src="${photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.style.display='none'">`
    : getInitials(name);

  $('chatHeaderName').textContent  = name;
  $('chatHeaderEmail').textContent = otherEmail;
  $('dmChatEmpty').style.display  = 'none';

  // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
  const active = $('dmChatActive');
  active.style.display       = 'flex';
  active.style.flexDirection = 'column';
  active.style.flex          = '1';
  active.style.overflow      = 'hidden';

  renderConvList($('convSearchInput').value);

  // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
  if (msgUnsubscribe) { msgUnsubscribe(); msgUnsubscribe = null; }

  // –ó–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –ø–æ conversationId ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–Ω–µ –Ω—É–∂–µ–Ω —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å)
  const mq = query(collection(db,'messages'), where('conversationId','==',convId));
  msgUnsubscribe = onSnapshot(mq, snap => {
    const container = $('dmMessages');
    container.innerHTML = '';

    const msgs = [];
    snap.forEach(d => msgs.push({ id: d.id, ...d.data() }));
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    msgs.sort((a,b) => (a.createdAt?.toMillis?.()||0) - (b.createdAt?.toMillis?.()||0));

    if (msgs.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:20px;">–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É üëã</div>';
      return;
    }

    msgs.forEach(data => {
      const isOut = data.fromEmail === currentUser?.email;
      const time  = data.createdAt
        ? new Date(data.createdAt.toDate()).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})
        : '...';
      const bubble = document.createElement('div');
      bubble.className = 'msg-bubble ' + (isOut ? 'msg-out' : 'msg-in');
      bubble.innerHTML = `${escapeHtml(data.text)}<div class="msg-time">${time}</div>`;
      container.appendChild(bubble);
    });
    container.scrollTop = container.scrollHeight;
  }, err => {
    log('–û—à–∏–±–∫–∞ messages onSnapshot:', err.code, err.message);
    $('dmMessages').innerHTML =
      `<div style="color:var(--danger);text-align:center;padding:20px;font-size:13px;">
        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}
       </div>`;
  });
}

function escapeHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ‚îÄ SEND DM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.sendDm = async () => {
  const textEl = $('dmInput');
  const text   = textEl.value.trim();

  log('sendDm –≤—ã–∑–≤–∞–Ω:', { text, currentUser: currentUser?.email, currentConvId, currentChatEmail });

  if (!text)            { log('–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞'); return; }
  if (!currentUser)     { alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç'); return; }
  if (!currentConvId)   { alert('–î–∏–∞–ª–æ–≥ –Ω–µ –≤—ã–±—Ä–∞–Ω'); return; }
  if (!currentChatEmail){ alert('–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫'); return; }

  textEl.value = '';
  textEl.style.height = 'auto';
  $('dmSendBtn').disabled = true;

  try {
    const msgData = {
      conversationId: currentConvId,
      fromEmail:      currentUser.email,
      toEmail:        currentChatEmail,
      text:           text,
      createdAt:      serverTimestamp()
    };
    log('–ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ:', msgData);
    const msgRef = await addDoc(collection(db,'messages'), msgData);
    log('–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∞–Ω–æ, id:', msgRef.id);

    await updateDoc(doc(db,'conversations',currentConvId), {
      lastMessage: text,
      updatedAt:   serverTimestamp()
    });
    log('Conversation –æ–±–Ω–æ–≤–ª—ë–Ω');
  } catch(e) {
    log('–û–®–ò–ë–ö–ê –æ—Ç–ø—Ä–∞–≤–∫–∏:', e.code, e.message);
    logErr('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.code + ' ' + e.message); alert('–û—à–∏–±–∫–∞: ' + e.code + '\n' + e.message);
    textEl.value = text; // –≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—Å—Ç
  } finally {
    $('dmSendBtn').disabled = false;
    textEl.focus();
  }
};

// ‚îÄ‚îÄ‚îÄ NEW CHAT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openNewChat = async () => {
  selectedNewChatUser = null;
  $('userSearchInput').value   = '';
  $('manualEmailInput').value  = '';
  $('emailInputError').style.display = 'none';
  $('startChatBtn').disabled   = true;
  $('newChatModal').classList.add('open');
  $('userPickList').innerHTML  =
    '<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:14px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  await loadAllUsers();
  renderUserPickList('');
};

window.closeNewChat = () => {
  $('newChatModal').classList.remove('open');
  selectedNewChatUser = null;
};

window.startChatByEmail = async () => {
  const emailEl = $('manualEmailInput');
  const errEl   = $('emailInputError');
  const email   = emailEl.value.trim().toLowerCase();
  errEl.style.display = 'none';

  if (!email) { errEl.textContent='–í–≤–µ–¥–∏—Ç–µ email'; errEl.style.display='block'; return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    errEl.textContent='–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email'; errEl.style.display='block'; return;
  }
  if (email === currentUser.email) {
    errEl.textContent='–ù–µ–ª—å–∑—è –Ω–∞–ø–∏—Å–∞—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ'; errEl.style.display='block'; return;
  }

  const btn = emailEl.nextElementSibling;
  btn.disabled=true; btn.textContent='...';
  try {
    const convId = await getOrCreateConversation(email);
    closeNewChat();
    showTab('messages');
    openConversation(convId, email);
  } catch(e) {
    errEl.textContent='–û—à–∏–±–∫–∞: '+e.message; errEl.style.display='block';
  } finally {
    btn.disabled=false; btn.textContent='–ù–∞–ø–∏—Å–∞—Ç—å';
  }
};

function renderUserPickList(filter) {
  const list = $('userPickList');
  list.innerHTML = '';
  if (!allUsers.length) {
    list.innerHTML =
      '<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:16px;">–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.<br>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–≤–æ–¥ email –≤—ã—à–µ.</div>';
    return;
  }
  const filtered = allUsers.filter(u =>
    u.name?.toLowerCase().includes(filter.toLowerCase()) ||
    u.email?.toLowerCase().includes(filter.toLowerCase())
  );
  if (!filtered.length) {
    list.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:16px;">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
    return;
  }
  filtered.forEach(u => {
    const sel  = selectedNewChatUser?.uid === u.uid;
    const item = document.createElement('div');
    item.className = 'user-pick-item' + (sel ? ' selected' : '');
    item.innerHTML = `
      <div class="user-pick-avatar">
        ${u.photo ? `<img src="${u.photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : getInitials(u.name)}
      </div>
      <div style="flex:1;min-width:0;">
        <div class="user-pick-name">${u.name||'–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
        <div class="user-pick-email">${u.email}</div>
      </div>
      ${sel ? '<span style="color:var(--primary);font-size:18px;">‚úì</span>' : ''}`;
    item.onclick = () => {
      selectedNewChatUser = u;
      $('startChatBtn').disabled = false;
      renderUserPickList(filter);
    };
    list.appendChild(item);
  });
}

window.filterUserList = val => renderUserPickList(val);

window.startNewChat = async () => {
  if (!selectedNewChatUser || !currentUser) return;
  const btn = $('startChatBtn');
  btn.disabled=true; btn.textContent='...';
  try {
    const convId = await getOrCreateConversation(selectedNewChatUser.email);
    closeNewChat();
    showTab('messages');
    openConversation(convId, selectedNewChatUser.email);
  } catch(e) {
    alert('–û—à–∏–±–∫–∞: '+e.message);
  } finally {
    btn.disabled=false; btn.textContent='–ù–∞—á–∞—Ç—å —á–∞—Ç';
  }
};

async function getOrCreateConversation(otherEmail) {
  log('getOrCreateConversation —Å:', otherEmail);
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ
  for (const c of convSnapshot) {
    if ((c.participantsEmails||[]).includes(currentUser.email) &&
        (c.participantsEmails||[]).includes(otherEmail)) {
      log('–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–∏–∞–ª–æ–≥ –Ω–∞–π–¥–µ–Ω:', c.id);
      return c.id;
    }
  }
  // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π
  log('–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥...');
  const newConv = await addDoc(collection(db,'conversations'), {
    participantsEmails: [currentUser.email, otherEmail],
    lastMessage: '',
    createdAt:   serverTimestamp(),
    updatedAt:   serverTimestamp()
  });
  log('–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω:', newConv.id);
  return newConv.id;
}

// ‚îÄ‚îÄ‚îÄ MISC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.autoResize = el => {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
};
</script>
</body>
</html>
