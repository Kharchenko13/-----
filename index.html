<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–π –æ–±–ª–∞—á–Ω—ã–π –ø—Ä–æ–µ–∫—Ç</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #4f46e5;
    --primary-dark: #3730a3;
    --accent: #06b6d4;
    --danger: #ef4444;
    --success: #22c55e;
    --warn: #f59e0b;
    --bg: #f1f5f9;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #1e293b;
    --muted: #94a3b8;
    --shadow: 0 4px 24px rgba(79,70,229,0.08);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* TABS */
  .app-tabs { display:flex; background:var(--card); border-bottom:2px solid var(--border); position:sticky; top:0; z-index:100; box-shadow:0 2px 12px rgba(0,0,0,0.06); }
  .tab-btn { flex:1; padding:16px 8px; border:none; background:transparent; font-family:'Nunito',sans-serif; font-size:15px; font-weight:700; color:var(--muted); cursor:pointer; transition:all 0.25s; border-bottom:3px solid transparent; }
  .tab-btn.active { color:var(--primary); border-bottom-color:var(--primary); background:linear-gradient(to bottom,#f0f0ff,transparent); }

  /* VIEWS */
  .view { display:none; padding:20px; max-width:760px; margin:0 auto; }
  .view.active { display:block; }
  #view-messages { padding:0; max-width:100%; height:calc(100vh - 56px); }
  #view-messages.active { display:flex; flex-direction:column; }

  /* AUTH */
  .auth-bar { background:var(--card); padding:14px 20px; border-radius:14px; margin-bottom:20px; display:flex; align-items:center; gap:14px; box-shadow:var(--shadow); border:1px solid var(--border); }
  .user-avatar { width:42px; height:42px; border-radius:50%; border:2px solid var(--primary); object-fit:cover; }

  /* BUTTONS */
  .btn { padding:10px 18px; border:none; border-radius:10px; font-family:'Nunito',sans-serif; font-weight:700; font-size:14px; cursor:pointer; transition:all 0.2s; }
  .btn-primary { background:var(--primary); color:white; }
  .btn-primary:hover { background:var(--primary-dark); }
  .btn-danger { background:var(--danger); color:white; }
  .btn-sm { padding:6px 12px; font-size:13px; }

  /* FORM */
  .form-card { background:var(--card); padding:22px; border-radius:16px; box-shadow:var(--shadow); border:1px solid var(--border); margin-bottom:22px; }
  .form-card h3 { font-size:16px; font-weight:800; margin-bottom:14px; color:var(--primary); }
  .form-input { width:100%; padding:11px 14px; border:1px solid var(--border); border-radius:10px; font-family:'Nunito',sans-serif; font-size:14px; color:var(--text); background:var(--bg); margin-bottom:10px; transition:border-color 0.2s; }
  .form-input:focus { outline:none; border-color:var(--primary); background:white; }
  .file-drop { border:2px dashed var(--border); border-radius:10px; padding:18px; text-align:center; cursor:pointer; color:var(--muted); font-size:13px; transition:all 0.2s; margin-bottom:10px; }
  .file-drop:hover, .file-drop.has-file { border-color:var(--primary); background:#f0f0ff; color:var(--primary); }
  .preview-image { max-width:100%; max-height:180px; border-radius:10px; margin:8px 0; }

  /* POSTS */
  .post { background:var(--card); border-radius:16px; padding:16px; box-shadow:var(--shadow); border:1px solid var(--border); margin-bottom:14px; animation:fadeUp 0.3s ease; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  .post-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .post-avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; border:2px solid var(--border); }
  .post-name { font-weight:700; font-size:14px; }
  .post-time { font-size:12px; color:var(--muted); margin-left:auto; }
  .status-badge { font-size:11px; font-weight:700; padding:3px 9px; border-radius:20px; color:white; }
  .status-new { background:#94a3b8; }
  .status-progress { background:var(--warn); }
  .status-done { background:var(--success); }
  .post-text { font-size:14px; line-height:1.5; margin-bottom:10px; }
  .post-image { width:100%; max-height:280px; object-fit:cover; border-radius:10px; margin-bottom:12px; cursor:pointer; transition:transform 0.2s; }
  .post-image:hover { transform:scale(1.01); }
  .post-actions { display:flex; gap:8px; flex-wrap:wrap; }
  .act-btn { padding:6px 14px; border:none; border-radius:20px; font-family:'Nunito',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:all 0.2s; }
  .act-like { background:#f0f9ff; color:#0284c7; } .act-like:hover { background:#e0f2fe; }
  .act-dislike { background:#fff1f2; color:var(--danger); } .act-dislike:hover { background:#ffe4e6; }
  .act-status { background:#f0f0ff; color:var(--primary); } .act-status:hover { background:#e0e7ff; }
  .act-done { background:#f0fdf4; color:var(--success); } .act-done:hover { background:#dcfce7; }
  .act-del { background:#fff1f2; color:var(--danger); } .act-del:hover { background:#ffe4e6; }
  .section-title { text-align:center; font-size:16px; font-weight:800; color:#64748b; margin-bottom:16px; }

  /* MESSAGES LAYOUT */
  .dm-layout { display:flex; height:100%; overflow:hidden; }
  .dm-sidebar { width:300px; min-width:300px; border-right:1px solid var(--border); background:var(--card); display:flex; flex-direction:column; }
  .dm-sidebar-header { padding:16px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
  .dm-sidebar-header h4 { font-size:15px; font-weight:800; }
  .new-chat-btn { background:var(--primary); color:white; border:none; border-radius:8px; padding:6px 14px; font-family:'Nunito',sans-serif; font-weight:700; font-size:13px; cursor:pointer; }
  .new-chat-btn:hover { background:var(--primary-dark); }
  .dm-search { padding:10px 14px; border:none; border-bottom:1px solid var(--border); width:100%; font-family:'Nunito',sans-serif; font-size:14px; background:#f8fafc; }
  .dm-search:focus { outline:none; background:white; }
  .dm-list { overflow-y:auto; flex:1; }
  .dm-item { display:flex; align-items:center; gap:12px; padding:12px 18px; cursor:pointer; transition:background 0.15s; border-bottom:1px solid #f1f5f9; }
  .dm-item:hover, .dm-item.active { background:#f0f0ff; }
  .dm-item-avatar { width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--accent)); display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:16px; flex-shrink:0; overflow:hidden; }
  .dm-item-avatar img { width:100%; height:100%; object-fit:cover; }
  .dm-item-info { flex:1; min-width:0; }
  .dm-item-name { font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .dm-item-preview { font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px; }
  .dm-item-time { font-size:11px; color:var(--muted); flex-shrink:0; }

  /* CHAT */
  .dm-chat { flex:1; display:flex; flex-direction:column; background:#f8fafc; overflow:hidden; }
  .dm-chat-empty { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--muted); gap:10px; }
  .dm-chat-empty .icon { font-size:52px; }
  .dm-chat-active { display:none; flex-direction:column; flex:1; overflow:hidden; }
  .dm-chat-header { padding:14px 20px; background:var(--card); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
  .dm-chat-header-avatar { width:38px; height:38px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--accent)); display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:14px; overflow:hidden; flex-shrink:0; }
  .dm-chat-header-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
  .dm-chat-header-name { font-weight:700; font-size:15px; }
  .dm-chat-header-email { font-size:12px; color:var(--muted); }
  .dm-messages { flex:1; overflow-y:auto; padding:16px 20px; display:flex; flex-direction:column; gap:8px; }
  .msg-bubble { max-width:70%; padding:10px 14px; border-radius:16px; font-size:14px; line-height:1.5; word-break:break-word; animation:bubbleIn 0.2s ease; }
  @keyframes bubbleIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
  .msg-out { align-self:flex-end; background:var(--primary); color:white; border-bottom-right-radius:4px; }
  .msg-in  { align-self:flex-start; background:white; color:var(--text); border-bottom-left-radius:4px; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
  .msg-time { font-size:10px; margin-top:4px; opacity:0.65; text-align:right; }
  .msg-in .msg-time { text-align:left; }
  .dm-input-area { padding:12px 16px; background:var(--card); border-top:1px solid var(--border); display:flex; gap:10px; align-items:flex-end; }
  .dm-text-input { flex:1; padding:11px 16px; border:1px solid var(--border); border-radius:24px; font-family:'Nunito',sans-serif; font-size:14px; resize:none; max-height:100px; background:var(--bg); color:var(--text); transition:border-color 0.2s; }
  .dm-text-input:focus { outline:none; border-color:var(--primary); background:white; }
  .dm-send-btn { width:44px; height:44px; border-radius:50%; border:none; background:var(--primary); color:white; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; flex-shrink:0; }
  .dm-send-btn:hover { background:var(--primary-dark); transform:scale(1.05); }
  .dm-send-btn:disabled { background:var(--muted); cursor:not-allowed; transform:none; }

  /* MODAL */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal-box { background:var(--card); border-radius:20px; padding:28px; width:420px; max-width:90vw; box-shadow:0 20px 60px rgba(0,0,0,0.2); }
  .modal-box h3 { font-size:18px; font-weight:800; margin-bottom:16px; color:var(--primary); }
  .user-pick-list { max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-bottom:16px; }
  .user-pick-item { display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:12px; cursor:pointer; transition:background 0.15s; border:2px solid transparent; }
  .user-pick-item:hover { background:#f0f0ff; }
  .user-pick-item.selected { border-color:var(--primary); background:#f0f0ff; }
  .user-pick-avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--accent)); display:flex; align-items:center; justify-content:center; color:white; font-weight:800; overflow:hidden; flex-shrink:0; }
  .user-pick-avatar img { width:100%; height:100%; object-fit:cover; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:4px; }

  /* IMG MODAL */
  .img-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:300; align-items:center; justify-content:center; }
  .img-modal.open { display:flex; }
  .img-modal img { max-width:90vw; max-height:90vh; border-radius:8px; }
  .img-modal-close { position:absolute; top:18px; right:22px; color:white; font-size:36px; cursor:pointer; }

  .not-logged { text-align:center; padding:40px 20px; color:var(--muted); font-size:15px; font-weight:600; }
  .not-logged .icon { font-size:48px; display:block; margin-bottom:12px; }
  ::-webkit-scrollbar { width:5px; }
  ::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:10px; }
</style>
</head>
<body>

<!-- Image modal -->
<div class="img-modal" id="imgModal">
  <span class="img-modal-close" onclick="document.getElementById('imgModal').classList.remove('open')">&times;</span>
  <img id="imgModalSrc">
</div>

<!-- New chat modal -->
<div class="modal-overlay" id="newChatModal">
  <div class="modal-box">
    <h3>üí¨ –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</h3>
    <div style="margin-bottom:14px;">
      <label style="font-size:13px;font-weight:700;color:var(--muted);display:block;margin-bottom:6px;">‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –ø–æ email:</label>
      <div style="display:flex;gap:8px;">
        <input class="form-input" id="manualEmailInput" type="email" placeholder="example@gmail.com"
          style="margin:0;flex:1;" onkeydown="if(event.key==='Enter')window.startChatByEmail()">
        <button class="btn btn-primary" onclick="window.startChatByEmail()" style="white-space:nowrap;width:auto;">–ù–∞–ø–∏—Å–∞—Ç—å</button>
      </div>
      <div id="emailError" style="color:var(--danger);font-size:12px;margin-top:4px;display:none;"></div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
      <div style="flex:1;height:1px;background:var(--border);"></div>
      <span style="font-size:12px;color:var(--muted);font-weight:600;">–∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞</span>
      <div style="flex:1;height:1px;background:var(--border);"></div>
    </div>
    <input class="form-input" id="userSearchInput" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="window.filterUserList(this.value)" style="margin-bottom:10px;">
    <div class="user-pick-list" id="userPickList">
      <div style="text-align:center;color:var(--muted);padding:20px;font-size:14px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="window.closeNewChat()" style="background:var(--bg);color:var(--text);">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="startChatBtn" onclick="window.startNewChat()" disabled>–ù–∞—á–∞—Ç—å —á–∞—Ç</button>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="app-tabs">
  <button class="tab-btn active" onclick="window.showTab('feed')">üìã –ó–∞—è–≤–∫–∏</button>
  <button class="tab-btn" onclick="window.showTab('messages')">‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏—è</button>
</div>

<!-- FEED VIEW -->
<div class="view active" id="view-feed">
  <div class="auth-bar">
    <button class="btn btn-primary" id="loginBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <div id="userInfo" style="display:none;flex:1;align-items:center;gap:12px;">
      <img id="userPhoto" class="user-avatar" src="" alt="">
      <span style="font-weight:700;font-size:15px;" id="userName"></span>
      <button class="btn btn-danger btn-sm" id="logoutBtn" style="margin-left:auto;">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div class="form-card" id="messageForm" style="display:none;">
    <h3>‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
    <input class="form-input" type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" readonly>
    <input class="form-input" type="email" id="email" placeholder="Email" readonly>
    <input class="form-input" type="text" id="content" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...">
    <div class="file-drop" id="fileInput" onclick="document.getElementById('imageUpload').click()">
      <span id="fileInputText">üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ 5 –ú–ë)</span>
    </div>
    <input type="file" id="imageUpload" accept="image/*" style="display:none;">
    <div id="imagePreview"></div>
    <button class="btn btn-primary" id="mainBtn" style="width:100%;margin-top:6px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
  </div>

  <div class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏</div>
  <div id="feed"></div>
</div>

<!-- MESSAGES VIEW -->
<div class="view" id="view-messages">
  <div id="dmNotLogged" class="not-logged" style="display:none;">
    <span class="icon">üîê</span>
    –í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
  </div>
  <div class="dm-layout" id="dmLayout" style="display:none;">
    <div class="dm-sidebar">
      <div class="dm-sidebar-header">
        <h4>–î–∏–∞–ª–æ–≥–∏</h4>
        <button class="new-chat-btn" onclick="window.openNewChat()">+ –ù–æ–≤—ã–π</button>
      </div>
      <input class="dm-search" id="convSearchInput" placeholder="üîç –ü–æ–∏—Å–∫ –¥–∏–∞–ª–æ–≥–æ–≤..." oninput="window.filterConvList(this.value)">
      <div class="dm-list" id="dmList">
        <div style="padding:20px;text-align:center;color:var(--muted);font-size:13px;">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</div>
      </div>
    </div>

    <div class="dm-chat">
      <div class="dm-chat-empty" id="dmChatEmpty">
        <div class="icon">üí¨</div>
        <p style="font-size:14px;font-weight:600;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π</p>
      </div>
      <div class="dm-chat-active" id="dmChatActive">
        <div class="dm-chat-header">
          <div class="dm-chat-header-avatar" id="chatHeaderAvatar">?</div>
          <div>
            <div class="dm-chat-header-name" id="chatHeaderName"></div>
            <div class="dm-chat-header-email" id="chatHeaderEmail"></div>
          </div>
        </div>
        <div class="dm-messages" id="dmMessages"></div>
        <div class="dm-input-area">
          <textarea class="dm-text-input" id="dmInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();window.sendDm();}"
            oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px'"></textarea>
          <button class="dm-send-btn" id="dmSendBtn" onclick="window.sendDm()">‚û§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot,
  doc, updateDoc, increment, serverTimestamp, deleteDoc,
  getDocs, setDoc, where
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import {
  getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import {
  getStorage, ref, uploadBytes, getDownloadURL, deleteObject
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoJg-KVJ0rIHP116EwP3e-Koz2yficbXY",
  authDomain: "fir-f0bac.firebaseapp.com",
  projectId: "fir-f0bac",
  storageBucket: "fir-f0bac.firebasestorage.app",
  messagingSenderId: "1060638693890",
  appId: "1:1060638693890:web:79278db107221db79f651b"
};

const app      = initializeApp(firebaseConfig);
const db       = getFirestore(app);
const auth     = getAuth(app);
const storage  = getStorage(app);
const provider = new GoogleAuthProvider();

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser      = null;
let selectedImageFile = null;
let currentConvId    = null;
let currentChatEmail = null;
let allUsers         = [];
let convSnapshot     = [];
let msgUnsubscribe   = null;
let selectedNewChatUser = null;

const $ = id => document.getElementById(id);

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showTab = (tab) => {
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', (i===0&&tab==='feed') || (i===1&&tab==='messages'));
  });
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  $('view-' + tab).classList.add('active');
};

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('loginBtn').onclick  = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
$('logoutBtn').onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if (user) {
    $('loginBtn').style.display    = 'none';
    $('userInfo').style.display    = 'flex';
    $('userName').textContent      = user.displayName;
    $('userPhoto').src             = user.photoURL || '';
    $('name').value                = user.displayName;
    $('email').value               = user.email;
    $('messageForm').style.display = 'block';
    $('dmNotLogged').style.display = 'none';
    $('dmLayout').style.display    = 'flex';

    // –ü—Ä–∞–≤–∏–ª–æ: allow write if request.auth.uid == userId ‚Üí uid = document ID ‚úì
    try {
      await setDoc(doc(db, 'users', user.uid), {
        email: user.email, name: user.displayName,
        photo: user.photoURL || '', updatedAt: serverTimestamp()
      }, { merge: true });
    } catch(e) { console.error('setDoc users:', e.code, e.message); }

    loadAllUsers();
    listenConversations();
  } else {
    $('loginBtn').style.display    = 'block';
    $('userInfo').style.display    = 'none';
    $('messageForm').style.display = 'none';
    $('dmNotLogged').style.display = 'block';
    $('dmLayout').style.display    = 'none';
  }
});

// ‚îÄ‚îÄ LOAD USERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAllUsers() {
  try {
    const snap = await getDocs(collection(db, 'users'));
    allUsers = [];
    snap.forEach(d => {
      const data = d.data();
      if (data.email !== currentUser?.email) allUsers.push({ uid: d.id, ...data });
    });
  } catch(e) { console.error('loadAllUsers:', e.code, e.message); }
}

// ‚îÄ‚îÄ IMAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('imageUpload').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5*1024*1024) { alert('–§–∞–π–ª > 5 –ú–ë'); e.target.value=''; return; }
  if (!file.type.startsWith('image/')) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'); e.target.value=''; return; }
  selectedImageFile = file;
  $('fileInput').classList.add('has-file');
  $('fileInputText').textContent = 'üì∏ ' + file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    $('imagePreview').innerHTML =
      '<img src="' + ev.target.result + '" class="preview-image">' +
      '<button class="btn btn-danger btn-sm" style="margin-top:6px;" onclick="window.removeImg()">–£–¥–∞–ª–∏—Ç—å</button>';
  };
  reader.readAsDataURL(file);
});

window.removeImg = () => {
  selectedImageFile = null;
  $('imageUpload').value = '';
  $('fileInput').classList.remove('has-file');
  $('fileInputText').textContent = 'üìÅ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ 5 –ú–ë)';
  $('imagePreview').innerHTML = '';
};

async function uploadImage(file, userId) {
  const name = Date.now() + '_' + file.name;
  const r = ref(storage, 'images/' + userId + '/' + name);
  const snap = await uploadBytes(r, file);
  return { url: await getDownloadURL(snap.ref), path: 'images/' + userId + '/' + name };
}

// ‚îÄ‚îÄ POST SUBMIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('mainBtn').onclick = async e => {
  e.preventDefault();
  const content = $('content').value.trim();
  if (!content) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!');
  const btn = $('mainBtn');
  btn.disabled = true; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
  try {
    let img = null;
    if (selectedImageFile) img = await uploadImage(selectedImageFile, currentUser.uid);
    await addDoc(collection(db,'requests'), {
      name: currentUser.displayName, email: currentUser.email,
      photo: currentUser.photoURL, text: content,
      likes: 0, dislikes: 0, status: 'new',
      createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
      imageUrl: img ? img.url : null, imagePath: img ? img.path : null,
      userId: currentUser.uid
    });
    $('content').value = '';
    window.removeImg();
    alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
  } catch(e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
  finally { btn.disabled=false; btn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ'; }
};

// ‚îÄ‚îÄ FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onSnapshot(query(collection(db,'requests'), orderBy('createdAt','desc')), snap => {
  const feed = $('feed');
  feed.innerHTML = '';
  if (snap.empty) { feed.innerHTML='<p style="text-align:center;color:#94a3b8;padding:30px;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</p>'; return; }
  snap.forEach(ds => {
    const d = ds.data(), id = ds.id;
    const time = d.createdAt ? new Date(d.createdAt.toDate()).toLocaleString('ru-RU') : '‚Ä¶';
    const sc = {new:'new',in_progress:'progress',done:'done'}[d.status||'new']||'new';
    const sl = {new:'–ù–æ–≤–æ–µ',in_progress:'–í —Ä–∞–±–æ—Ç–µ',done:'–ó–∞–≤–µ—Ä—à–µ–Ω–æ'}[d.status||'new']||'new';
    const imgHtml = d.imageUrl ? '<img src="' + d.imageUrl + '" class="post-image" onclick="window._img(\'' + d.imageUrl + '\')">' : '';
    const el = document.createElement('div');
    el.className = 'post';
    el.innerHTML =
      '<div class="post-header">' +
        '<img src="' + (d.photo||'https://via.placeholder.com/32') + '" class="post-avatar" onerror="this.src=\'https://via.placeholder.com/32\'">' +
        '<span class="post-name">' + (d.name||'–ê–Ω–æ–Ω–∏–º') + '</span>' +
        '<span class="post-time">' + time + '</span>' +
        '<span class="status-badge status-' + sc + '">' + sl + '</span>' +
      '</div>' +
      '<p class="post-text">' + (d.text||'') + '</p>' + imgHtml +
      '<div class="post-actions">' +
        '<button class="act-btn act-like"    onclick="window._like(\''    + id + '\')">üëç ' + (d.likes||0) + '</button>' +
        '<button class="act-btn act-dislike" onclick="window._dislike(\'' + id + '\')">üëé ' + (d.dislikes||0) + '</button>' +
        '<button class="act-btn act-status"  onclick="window._status(\''  + id + '\',\'in_progress\')">–í —Ä–∞–±–æ—Ç—É</button>' +
        '<button class="act-btn act-done"    onclick="window._status(\''  + id + '\',\'done\')">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</button>' +
        '<button class="act-btn act-del"     onclick="window._delete(\''  + id + '\',\'' + (d.imagePath||'') + '\')">üóë</button>' +
      '</div>';
    feed.appendChild(el);
  });
}, e => { $('feed').innerHTML = '<p style="color:red;text-align:center;">–û—à–∏–±–∫–∞: ' + e.message + '</p>'; });

window._like    = id => updateDoc(doc(db,'requests',id),{likes:increment(1),updatedAt:serverTimestamp()}).catch(console.error);
window._dislike = id => {
  if (localStorage.getItem('dl_'+id)==='1') return alert('–£–∂–µ –¥–∏–∑–ª–∞–π–∫');
  updateDoc(doc(db,'requests',id),{dislikes:increment(1),updatedAt:serverTimestamp()})
    .then(()=>localStorage.setItem('dl_'+id,'1')).catch(console.error);
};
window._status  = (id,s) => updateDoc(doc(db,'requests',id),{status:s,updatedAt:serverTimestamp()}).catch(console.error);
window._delete  = async (id, path) => {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
  if (path) try { await deleteObject(ref(storage,path)); } catch(e){}
  deleteDoc(doc(db,'requests',id)).catch(console.error);
};
window._img = url => { $('imgModalSrc').src=url; $('imgModal').classList.add('open'); };

// ‚îÄ‚îÄ CONVERSATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ß–∏—Ç–∞–µ–º –≤—Å–µ conversations, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–æ participantsEmails
// –ü—Ä–∞–≤–∏–ª–æ: allow read if email in resource.data.participantsEmails
// –ù–û: onSnapshot —á–∏—Ç–∞–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é ‚Äî –Ω—É–∂–Ω–æ allow read –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Ç–æ–∂–µ
// –ü–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º getDocs –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏, –ø–æ—Ç–æ–º onSnapshot
function listenConversations() {
  if (!currentUser) return;
  const cq = query(collection(db,'conversations'), orderBy('updatedAt','desc'));
  onSnapshot(cq, snap => {
    convSnapshot = [];
    snap.forEach(d => {
      const data = d.data();
      // –í–ê–ñ–ù–û: –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è participantsEmails ‚Äî —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö Firebase
      if ((data.participantsEmails||[]).includes(currentUser.email)) {
        convSnapshot.push({ id: d.id, ...data });
      }
    });
    renderConvList();
  }, e => console.error('conversations:', e.code, e.message));
}

function getOtherEmail(conv) {
  return (conv.participantsEmails||[]).find(e => e !== currentUser?.email) || '';
}

function getInitials(name) {
  if (!name) return '?';
  return name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
}

function renderConvList(filter='') {
  const list = $('dmList');
  list.innerHTML = '';
  const filtered = convSnapshot.filter(c => getOtherEmail(c).toLowerCase().includes(filter.toLowerCase()));
  if (!filtered.length) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px;">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</div>';
    return;
  }
  filtered.forEach(conv => {
    const other = getOtherEmail(conv);
    const user  = allUsers.find(u => u.email===other);
    const name  = user ? user.name : other;
    const photo = user ? user.photo : '';
    const preview = (conv.lastMessage||'–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π').slice(0,40);
    const time  = conv.updatedAt ? new Date(conv.updatedAt.toDate()).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}) : '';
    const item  = document.createElement('div');
    item.className = 'dm-item' + (conv.id===currentConvId?' active':'');
    item.innerHTML =
      '<div class="dm-item-avatar">' +
        (photo ? '<img src="' + photo + '" onerror="this.style.display=\'none\'">' : getInitials(name)) +
      '</div>' +
      '<div class="dm-item-info">' +
        '<div class="dm-item-name">' + name + '</div>' +
        '<div class="dm-item-preview">' + preview + '</div>' +
      '</div>' +
      '<div class="dm-item-time">' + time + '</div>';
    item.onclick = () => openConversation(conv.id, other);
    list.appendChild(item);
  });
}

window.filterConvList = val => renderConvList(val);

// ‚îÄ‚îÄ OPEN CONVERSATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openConversation(convId, otherEmail) {
  currentConvId    = convId;
  currentChatEmail = otherEmail;   // —Å–æ—Ö—Ä–∞–Ω—è–µ–º ‚Äî sendDm –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ

  const user  = allUsers.find(u => u.email===otherEmail);
  const name  = user ? user.name : otherEmail;
  const photo = user ? user.photo : '';

  $('chatHeaderAvatar').innerHTML = photo
    ? '<img src="' + photo + '" onerror="this.style.display=\'none\'">'
    : getInitials(name);
  $('chatHeaderName').textContent  = name;
  $('chatHeaderEmail').textContent = otherEmail;

  $('dmChatEmpty').style.display = 'none';
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç —Å–æ –≤—Å–µ–º–∏ –Ω—É–∂–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏
  const active = $('dmChatActive');
  active.style.display       = 'flex';
  active.style.flexDirection = 'column';
  active.style.flex          = '1';
  active.style.overflow      = 'hidden';

  renderConvList($('convSearchInput').value);

  if (msgUnsubscribe) { msgUnsubscribe(); msgUnsubscribe = null; }

  // –¢–æ–ª—å–∫–æ where –±–µ–∑ orderBy ‚Äî –Ω–µ –Ω—É–∂–µ–Ω —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å Firebase
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∞–º–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
  const mq = query(collection(db,'messages'), where('conversationId','==',convId));
  msgUnsubscribe = onSnapshot(mq, snap => {
    const container = $('dmMessages');
    container.innerHTML = '';

    const msgs = [];
    snap.forEach(d => msgs.push({ id: d.id, ...d.data() }));
    msgs.sort((a,b) => (a.createdAt ? a.createdAt.toMillis() : 0) - (b.createdAt ? b.createdAt.toMillis() : 0));

    if (!msgs.length) {
      container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:30px;font-size:14px;">–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É üëã</div>';
      return;
    }
    msgs.forEach(data => {
      const isOut = data.fromEmail === currentUser.email;
      const time  = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}) : '...';
      const bubble = document.createElement('div');
      bubble.className = 'msg-bubble ' + (isOut ? 'msg-out' : 'msg-in');
      bubble.innerHTML = escHtml(data.text) + '<div class="msg-time">' + time + '</div>';
      container.appendChild(bubble);
    });
    container.scrollTop = container.scrollHeight;
  }, e => {
    console.error('messages:', e.code, e.message);
    $('dmMessages').innerHTML = '<div style="color:var(--danger);text-align:center;padding:20px;">–û—à–∏–±–∫–∞: ' + e.code + '</div>';
  });
}

function escHtml(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ‚îÄ‚îÄ SEND DM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.sendDm = async () => {
  const text = $('dmInput').value.trim();
  if (!text)             return;
  if (!currentUser)      return alert('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
  if (!currentConvId)    return alert('–û—Ç–∫—Ä–æ–π—Ç–µ –¥–∏–∞–ª–æ–≥');
  if (!currentChatEmail) return alert('–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—å');

  $('dmInput').value = '';
  $('dmInput').style.height = 'auto';
  $('dmSendBtn').disabled = true;

  try {
    // –ü—Ä–∞–≤–∏–ª–æ messages: allow create if request.auth != null  ‚úì
    await addDoc(collection(db,'messages'), {
      conversationId: currentConvId,
      fromEmail:      currentUser.email,
      toEmail:        currentChatEmail,
      text:           text,
      createdAt:      serverTimestamp()
    });

    // –ü—Ä–∞–≤–∏–ª–æ conversations: allow update if email in participantsEmails  ‚úì
    await updateDoc(doc(db,'conversations',currentConvId), {
      lastMessage: text,
      updatedAt:   serverTimestamp()
    });
  } catch(e) {
    console.error('sendDm:', e.code, e.message);
    alert('–û—à–∏–±–∫–∞: ' + e.code + '\n' + e.message);
    $('dmInput').value = text;
  } finally {
    $('dmSendBtn').disabled = false;
    $('dmInput').focus();
  }
};

// ‚îÄ‚îÄ NEW CHAT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openNewChat = async () => {
  selectedNewChatUser = null;
  $('userSearchInput').value  = '';
  $('manualEmailInput').value = '';
  $('emailError').style.display = 'none';
  $('startChatBtn').disabled  = true;
  $('userPickList').innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  $('newChatModal').classList.add('open');
  await loadAllUsers();
  renderUserPickList('');
};

window.closeNewChat = () => {
  $('newChatModal').classList.remove('open');
  selectedNewChatUser = null;
};

window.startChatByEmail = async () => {
  const errEl = $('emailError');
  const email = $('manualEmailInput').value.trim().toLowerCase();
  errEl.style.display = 'none';
  if (!email) { errEl.textContent='–í–≤–µ–¥–∏—Ç–µ email'; errEl.style.display='block'; return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { errEl.textContent='–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'; errEl.style.display='block'; return; }
  if (email === currentUser.email) { errEl.textContent='–ù–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å —Å–µ–±–µ'; errEl.style.display='block'; return; }
  try {
    const convId = await getOrCreateConversation(email);
    window.closeNewChat();
    window.showTab('messages');
    openConversation(convId, email);
  } catch(e) { errEl.textContent='–û—à–∏–±–∫–∞: '+e.message; errEl.style.display='block'; }
};

function renderUserPickList(filter) {
  const list = $('userPickList');
  list.innerHTML = '';
  if (!allUsers.length) {
    list.innerHTML = '<div style="text-align:center;color:var(--muted);font-size:13px;padding:16px;">–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.<br>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–≤–æ–¥ email –≤—ã—à–µ.</div>';
    return;
  }
  const filtered = allUsers.filter(u =>
    (u.name||'').toLowerCase().includes(filter.toLowerCase()) ||
    (u.email||'').toLowerCase().includes(filter.toLowerCase())
  );
  if (!filtered.length) {
    list.innerHTML = '<div style="text-align:center;color:var(--muted);font-size:13px;padding:16px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
    return;
  }
  filtered.forEach(u => {
    const sel  = selectedNewChatUser && selectedNewChatUser.uid === u.uid;
    const item = document.createElement('div');
    item.className = 'user-pick-item' + (sel?' selected':'');
    item.innerHTML =
      '<div class="user-pick-avatar">' +
        (u.photo ? '<img src="' + u.photo + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">' : getInitials(u.name)) +
      '</div>' +
      '<div style="flex:1;min-width:0;">' +
        '<div style="font-weight:700;font-size:14px;">' + (u.name||'–ë–µ–∑ –∏–º–µ–Ω–∏') + '</div>' +
        '<div style="font-size:12px;color:var(--muted);">' + u.email + '</div>' +
      '</div>' +
      (sel ? '<span style="color:var(--primary);font-size:18px;">‚úì</span>' : '');
    item.onclick = () => { selectedNewChatUser=u; $('startChatBtn').disabled=false; renderUserPickList(filter); };
    list.appendChild(item);
  });
}

window.filterUserList = val => renderUserPickList(val);

window.startNewChat = async () => {
  if (!selectedNewChatUser) return;
  $('startChatBtn').disabled = true;
  try {
    const convId = await getOrCreateConversation(selectedNewChatUser.email);
    window.closeNewChat();
    window.showTab('messages');
    openConversation(convId, selectedNewChatUser.email);
  } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
  finally { $('startChatBtn').disabled=false; }
};

// –ö–õ–Æ–ß–ï–í–û–ï: —Å–æ–∑–¥–∞—ë–º conversations —Å –ø–æ–ª–µ–º participantsEmails
// –≠—Ç–æ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è –∏–∑ –ø—Ä–∞–≤–∏–ª Firebase:
// allow read, update: if request.auth.token.email in resource.data.participantsEmails
async function getOrCreateConversation(otherEmail) {
  for (const c of convSnapshot) {
    if ((c.participantsEmails||[]).includes(currentUser.email) &&
        (c.participantsEmails||[]).includes(otherEmail)) {
      return c.id;
    }
  }
  const newConv = await addDoc(collection(db,'conversations'), {
    participantsEmails: [currentUser.email, otherEmail],
    lastMessage: '',
    createdAt:   serverTimestamp(),
    updatedAt:   serverTimestamp()
  });
  return newConv.id;
}
</script>
</body>
</html>
